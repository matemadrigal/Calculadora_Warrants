<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculadora profesional de warrants europeos con modelo Black-Scholes-Merton. An√°lisis de opciones sobre √≠ndices.">
    <meta name="keywords" content="warrant, opciones, Black-Scholes, derivados, trading, BNP Paribas">
    <meta name="author" content="Mateo Madrigal">
    
    <!-- Open Graph -->
    <meta property="og:title" content="European Warrant Calculator">
    <meta property="og:description" content="Calculadora profesional de warrants con Black-Scholes">
    <meta property="og:type" content="website">
    
    <title>European Warrant Calculator v3.1 - Volatility Skew</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        terminal: {
                            bg: '#0A0E1A',
                            panel: '#111827',
                            card: '#1F2937',
                            border: '#374151',
                            accent: '#3B82F6',
                            success: '#10B981',
                            danger: '#EF4444',
                            warning: '#F59E0B',
                            muted: '#6B7280',
                            text: '#E5E7EB'
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Fira Code', 'Monaco', 'monospace']
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- PropTypes (required by Recharts) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>

    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'JetBrains Mono', monospace;
            background: #0A0E1A;
            color: #E5E7EB;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Hide number input spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0A0E1A;
        }
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4B5563;
        }

        /* Smooth transitions */
        .transition-smooth {
            transition: all 0.2s ease-in-out;
        }

        /* Glow effects */
        .glow-blue {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .glow-green {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        .glow-red {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        /* Input focus states */
        input:focus, select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Grid pattern background */
        .grid-pattern {
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="grid-pattern">
    <div id="root"></div>

    <script type="text/babel">
        // ============================================================================
        // EUROPEAN WARRANT CALCULATOR v3.1 - Volatility Skew
        // ============================================================================
        // Implementaci√≥n profesional del modelo Black-Scholes-Merton para warrants
        // europeos con todas las Greeks y an√°lisis completo de sensibilidad.
        //
        // Autor: Mateo Madrigal
        // Licencia: MIT
        // ============================================================================

        const { useState, useMemo, useEffect, useCallback } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, 
            Tooltip, Legend, ResponsiveContainer, ReferenceLine, Area, AreaChart 
        } = Recharts;

        // ============================================================================
        // SECCI√ìN 1: CONSTANTES Y CONFIGURACI√ìN
        // ============================================================================

        /**
         * N√∫mero de d√≠as en un a√±o para c√°lculos financieros.
         * Se usa 365.25 para considerar a√±os bisiestos (convenci√≥n est√°ndar).
         */
        const DAYS_PER_YEAR = 365.25;

        /**
         * Tolerancia para convergencia en Newton-Raphson.
         */
        const NEWTON_RAPHSON_TOLERANCE = 1e-8;

        /**
         * M√°ximo de iteraciones para Newton-Raphson.
         */
        const NEWTON_RAPHSON_MAX_ITERATIONS = 100;

        /**
         * L√≠mites de volatilidad impl√≠cita (en %).
         */
        const IV_BOUNDS = { min: 0.1, max: 500 };

        /**
         * Colores del tema para consistencia.
         */
        const COLORS = {
            primary: '#3B82F6',
            success: '#10B981',
            danger: '#EF4444',
            warning: '#F59E0B',
            muted: '#6B7280',
            text: '#E5E7EB',
            background: '#0A0E1A',
            card: '#1F2937',
            border: '#374151'
        };

        /**
         * Base de datos de activos subyacentes con par√°metros de mercado.
         * Datos actualizados a Diciembre 2024 (orientativos).
         */
        const UNDERLYING_ASSETS = {
            EUROSTOXX50: {
                name: 'Euro Stoxx 50',
                ticker: 'SX5E',
                region: 'Europa',
                currency: 'EUR',
                spotPrice: 4950,
                dividendYield: 2.8,
                volatility: 16,
                riskFreeRate: 2.5,
                description: '50 mayores empresas de la Eurozona',
                volIndex: 'VSTOXX',
                exchange: 'EUREX'
            },
            IBEX35: {
                name: 'IBEX 35',
                ticker: 'IBEX',
                region: 'Europa',
                currency: 'EUR',
                spotPrice: 11800,
                dividendYield: 3.5,
                volatility: 18,
                riskFreeRate: 2.8,
                description: 'Principal √≠ndice burs√°til espa√±ol',
                volIndex: 'VIBEX',
                exchange: 'BME'
            },
            DAX: {
                name: 'DAX 40',
                ticker: 'DAX',
                region: 'Europa',
                currency: 'EUR',
                spotPrice: 20400,
                dividendYield: 2.5,
                volatility: 15,
                riskFreeRate: 2.5,
                description: 'Principal √≠ndice burs√°til alem√°n',
                volIndex: 'VDAX',
                exchange: 'XETRA'
            },
            CAC40: {
                name: 'CAC 40',
                ticker: 'CAC',
                region: 'Europa',
                currency: 'EUR',
                spotPrice: 7400,
                dividendYield: 2.9,
                volatility: 17,
                riskFreeRate: 2.6,
                description: 'Principal √≠ndice burs√°til franc√©s',
                volIndex: 'VCAC',
                exchange: 'EURONEXT'
            },
            FTSE100: {
                name: 'FTSE 100',
                ticker: 'UKX',
                region: 'Europa',
                currency: 'GBP',
                spotPrice: 8300,
                dividendYield: 3.8,
                volatility: 14,
                riskFreeRate: 4.2,
                description: 'Principal √≠ndice del Reino Unido',
                volIndex: 'VFTSE',
                exchange: 'LSE'
            },
            SP500: {
                name: 'S&P 500',
                ticker: 'SPX',
                region: 'EEUU',
                currency: 'USD',
                spotPrice: 6050,
                dividendYield: 1.3,
                volatility: 14,
                riskFreeRate: 4.4,
                description: '500 mayores empresas de EEUU',
                volIndex: 'VIX',
                exchange: 'CBOE'
            },
            NASDAQ100: {
                name: 'NASDAQ 100',
                ticker: 'NDX',
                region: 'EEUU',
                currency: 'USD',
                spotPrice: 21500,
                dividendYield: 0.6,
                volatility: 20,
                riskFreeRate: 4.4,
                description: '100 mayores empresas tecnol√≥gicas',
                volIndex: 'VXN',
                exchange: 'NASDAQ'
            },
            DOWJONES: {
                name: 'Dow Jones',
                ticker: 'DJI',
                region: 'EEUU',
                currency: 'USD',
                spotPrice: 44900,
                dividendYield: 1.8,
                volatility: 13,
                riskFreeRate: 4.4,
                description: '30 mayores empresas industriales',
                volIndex: 'VXD',
                exchange: 'NYSE'
            },
            NIKKEI225: {
                name: 'Nikkei 225',
                ticker: 'NKY',
                region: 'Asia',
                currency: 'JPY',
                spotPrice: 38500,
                dividendYield: 1.8,
                volatility: 18,
                riskFreeRate: 0.4,
                description: 'Principal √≠ndice japon√©s',
                volIndex: 'VXJ',
                exchange: 'TSE'
            },
            CUSTOM: {
                name: 'Personalizado',
                ticker: 'CUSTOM',
                region: 'N/A',
                currency: 'EUR',
                spotPrice: 100,
                dividendYield: 2.0,
                volatility: 20,
                riskFreeRate: 3.0,
                description: 'Introduce tus propios valores',
                volIndex: null,
                exchange: null,
                isCustom: true
            }
        };

        /**
         * Lista ordenada de activos para el selector.
         */
        const ASSET_LIST = [
            { key: 'EUROSTOXX50', group: 'Europa' },
            { key: 'IBEX35', group: 'Europa' },
            { key: 'DAX', group: 'Europa' },
            { key: 'CAC40', group: 'Europa' },
            { key: 'FTSE100', group: 'Europa' },
            { key: 'SP500', group: 'EEUU' },
            { key: 'NASDAQ100', group: 'EEUU' },
            { key: 'DOWJONES', group: 'EEUU' },
            { key: 'NIKKEI225', group: 'Asia' },
            { key: 'CUSTOM', group: 'Otros' }
        ];

        // ============================================================================
        // SECCI√ìN 2: MATEM√ÅTICAS FINANCIERAS - BLACK-SCHOLES-MERTON
        // ============================================================================

        /**
         * Calcula la funci√≥n de distribuci√≥n acumulada de la normal est√°ndar N(x).
         * Usa la aproximaci√≥n de Abramowitz & Stegun (1964), f√≥rmula 26.2.17.
         * Precisi√≥n: |error| < 7.5√ó10‚Åª‚Å∏
         * 
         * @param {number} x - Valor de entrada
         * @returns {number} - Probabilidad acumulada P(Z ‚â§ x)
         */
        function normalCDF(x) {
            // Casos extremos para evitar overflow
            if (x < -10) return 0;
            if (x > 10) return 1;

            // Coeficientes de la aproximaci√≥n polinomial
            const a1 = 0.319381530;
            const a2 = -0.356563782;
            const a3 = 1.781477937;
            const a4 = -1.821255978;
            const a5 = 1.330274429;
            const p = 0.2316419;

            const absX = Math.abs(x);
            const t = 1 / (1 + p * absX);
            const t2 = t * t;
            const t3 = t2 * t;
            const t4 = t3 * t;
            const t5 = t4 * t;

            // PDF de la normal est√°ndar
            const pdf = Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);

            // Aproximaci√≥n polinomial
            const cdf = pdf * (a1 * t + a2 * t2 + a3 * t3 + a4 * t4 + a5 * t5);

            return x >= 0 ? 1 - cdf : cdf;
        }

        /**
         * Calcula la funci√≥n de densidad de probabilidad de la normal est√°ndar œÜ(x).
         * 
         * @param {number} x - Valor de entrada
         * @returns {number} - Densidad de probabilidad en x
         */
        function normalPDF(x) {
            return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
        }

        /**
         * Calcula d‚ÇÅ de la f√≥rmula Black-Scholes-Merton.
         * 
         * d‚ÇÅ = [ln(S/K) + (r - q + œÉ¬≤/2)T] / (œÉ‚àöT)
         * 
         * @param {number} S - Precio spot del subyacente
         * @param {number} K - Precio de ejercicio (strike)
         * @param {number} T - Tiempo a vencimiento en a√±os
         * @param {number} r - Tasa libre de riesgo (decimal)
         * @param {number} q - Dividend yield (decimal)
         * @param {number} sigma - Volatilidad (decimal)
         * @returns {number} - Valor de d‚ÇÅ
         */
        function calculateD1(S, K, T, r, q, sigma) {
            const numerator = Math.log(S / K) + (r - q + 0.5 * sigma * sigma) * T;
            const denominator = sigma * Math.sqrt(T);
            return numerator / denominator;
        }

        /**
         * Calcula d‚ÇÇ de la f√≥rmula Black-Scholes-Merton.
         * 
         * d‚ÇÇ = d‚ÇÅ - œÉ‚àöT
         * 
         * @param {number} d1 - Valor de d‚ÇÅ
         * @param {number} sigma - Volatilidad (decimal)
         * @param {number} T - Tiempo a vencimiento en a√±os
         * @returns {number} - Valor de d‚ÇÇ
         */
        function calculateD2(d1, sigma, T) {
            return d1 - sigma * Math.sqrt(T);
        }

        /**
         * Calcula el precio te√≥rico de una opci√≥n europea usando Black-Scholes-Merton.
         * 
         * Call: C = S¬∑e^(-qT)¬∑N(d‚ÇÅ) - K¬∑e^(-rT)¬∑N(d‚ÇÇ)
         * Put:  P = K¬∑e^(-rT)¬∑N(-d‚ÇÇ) - S¬∑e^(-qT)¬∑N(-d‚ÇÅ)
         * 
         * @param {Object} params - Par√°metros de la opci√≥n
         * @param {string} params.type - 'call' o 'put'
         * @param {number} params.spot - Precio spot (S)
         * @param {number} params.strike - Strike price (K)
         * @param {number} params.daysToExpiration - D√≠as hasta vencimiento
         * @param {number} params.riskFreeRate - Tasa libre de riesgo (%)
         * @param {number} params.dividendYield - Dividend yield (%)
         * @param {number} params.volatility - Volatilidad (%)
         * @returns {number} - Precio te√≥rico de la opci√≥n
         */
        function blackScholesPrice(params) {
            const { type, spot, strike, daysToExpiration, riskFreeRate, dividendYield, volatility } = params;

            // Validaci√≥n de volatilidad
            if (!volatility || volatility <= 0) return 0;

            // Convertir a formato decimal y a√±os
            const T = daysToExpiration / DAYS_PER_YEAR;
            const r = riskFreeRate / 100;
            const q = dividendYield / 100;
            const sigma = volatility / 100;

            // Caso especial: vencimiento (payoff intr√≠nseco)
            if (T <= 0) {
                return type === 'call' 
                    ? Math.max(0, spot - strike) 
                    : Math.max(0, strike - spot);
            }

            // C√°lculo de d‚ÇÅ y d‚ÇÇ
            const d1 = calculateD1(spot, strike, T, r, q, sigma);
            const d2 = calculateD2(d1, sigma, T);

            // Factores de descuento
            const discountDiv = Math.exp(-q * T);
            const discountRf = Math.exp(-r * T);

            if (type === 'call') {
                return spot * discountDiv * normalCDF(d1) - strike * discountRf * normalCDF(d2);
            } else {
                return strike * discountRf * normalCDF(-d2) - spot * discountDiv * normalCDF(-d1);
            }
        }

        /**
         * Calcula todas las Greeks de una opci√≥n europea.
         * 
         * @param {Object} params - Par√°metros de la opci√≥n (mismo formato que blackScholesPrice)
         * @returns {Object} - Objeto con todas las Greeks
         */
        function calculateGreeks(params) {
            const { type, spot, strike, daysToExpiration, riskFreeRate, dividendYield, volatility } = params;

            // Validaci√≥n
            if (!volatility || volatility <= 0 || daysToExpiration <= 0) {
                return {
                    delta: type === 'call' ? (spot > strike ? 1 : 0) : (spot < strike ? -1 : 0),
                    gamma: 0,
                    theta: 0,
                    vega: 0,
                    rho: 0
                };
            }

            // Convertir unidades
            const T = daysToExpiration / DAYS_PER_YEAR;
            const r = riskFreeRate / 100;
            const q = dividendYield / 100;
            const sigma = volatility / 100;

            // C√°lculos base
            const sqrtT = Math.sqrt(T);
            const d1 = calculateD1(spot, strike, T, r, q, sigma);
            const d2 = calculateD2(d1, sigma, T);
            const Nd1 = normalCDF(d1);
            const Nd2 = normalCDF(d2);
            const Nmd1 = normalCDF(-d1);
            const Nmd2 = normalCDF(-d2);
            const nd1 = normalPDF(d1);
            const discountDiv = Math.exp(-q * T);
            const discountRf = Math.exp(-r * T);

            let delta, gamma, theta, vega, rho;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // DELTA (Œî): Sensibilidad al precio del subyacente
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Call: Œî = e^(-qT) ¬∑ N(d‚ÇÅ)
            // Put:  Œî = e^(-qT) ¬∑ [N(d‚ÇÅ) - 1] = -e^(-qT) ¬∑ N(-d‚ÇÅ)
            if (type === 'call') {
                delta = discountDiv * Nd1;
            } else {
                delta = -discountDiv * Nmd1;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // GAMMA (Œì): Segunda derivada respecto al spot (curvatura)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Œì = e^(-qT) ¬∑ œÜ(d‚ÇÅ) / (S ¬∑ œÉ ¬∑ ‚àöT)
            // Gamma es igual para calls y puts
            gamma = (discountDiv * nd1) / (spot * sigma * sqrtT);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // THETA (Œò): Sensibilidad al paso del tiempo (time decay)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Œò_call = -[S¬∑e^(-qT)¬∑œÜ(d‚ÇÅ)¬∑œÉ/(2‚àöT)] - r¬∑K¬∑e^(-rT)¬∑N(d‚ÇÇ) + q¬∑S¬∑e^(-qT)¬∑N(d‚ÇÅ)
            // Œò_put  = -[S¬∑e^(-qT)¬∑œÜ(d‚ÇÅ)¬∑œÉ/(2‚àöT)] + r¬∑K¬∑e^(-rT)¬∑N(-d‚ÇÇ) - q¬∑S¬∑e^(-qT)¬∑N(-d‚ÇÅ)
            const thetaCommon = -(spot * discountDiv * nd1 * sigma) / (2 * sqrtT);
            
            if (type === 'call') {
                theta = thetaCommon - r * strike * discountRf * Nd2 + q * spot * discountDiv * Nd1;
            } else {
                theta = thetaCommon + r * strike * discountRf * Nmd2 - q * spot * discountDiv * Nmd1;
            }
            // Convertir a theta diario (dividir por 365.25)
            theta = theta / DAYS_PER_YEAR;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // VEGA (ŒΩ): Sensibilidad a la volatilidad
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ŒΩ = S ¬∑ e^(-qT) ¬∑ œÜ(d‚ÇÅ) ¬∑ ‚àöT
            // Vega es igual para calls y puts
            // Nota: Devolvemos vega por 1% de cambio en volatilidad
            vega = (spot * discountDiv * nd1 * sqrtT) / 100;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // RHO (œÅ): Sensibilidad a la tasa de inter√©s
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // œÅ_call = K ¬∑ T ¬∑ e^(-rT) ¬∑ N(d‚ÇÇ)
            // œÅ_put  = -K ¬∑ T ¬∑ e^(-rT) ¬∑ N(-d‚ÇÇ)
            // Nota: Devolvemos rho por 1% de cambio en tasa
            if (type === 'call') {
                rho = (strike * T * discountRf * Nd2) / 100;
            } else {
                rho = -(strike * T * discountRf * Nmd2) / 100;
            }

            return { delta, gamma, theta, vega, rho };
        }

        /**
         * Calcula la volatilidad impl√≠cita usando Newton-Raphson.
         * 
         * @param {Object} params - Par√°metros de la opci√≥n + marketPrice
         * @returns {number|null} - Volatilidad impl√≠cita (%) o null si no converge
         */
        function calculateImpliedVolatility(params) {
            const { marketPrice, type, spot, strike, daysToExpiration, riskFreeRate, dividendYield } = params;

            if (!marketPrice || marketPrice <= 0) return null;

            // Valor intr√≠nseco m√≠nimo
            const intrinsic = type === 'call' 
                ? Math.max(0, spot - strike * Math.exp(-riskFreeRate / 100 * daysToExpiration / DAYS_PER_YEAR))
                : Math.max(0, strike * Math.exp(-riskFreeRate / 100 * daysToExpiration / DAYS_PER_YEAR) - spot);
            
            if (marketPrice < intrinsic * 0.99) return null; // Precio menor que intr√≠nseco

            // Estimaci√≥n inicial usando aproximaci√≥n de Brenner-Subrahmanyam
            let sigma = Math.sqrt(2 * Math.PI / (daysToExpiration / DAYS_PER_YEAR)) * (marketPrice / spot) * 100;
            sigma = Math.max(IV_BOUNDS.min, Math.min(IV_BOUNDS.max, sigma || 30));

            for (let i = 0; i < NEWTON_RAPHSON_MAX_ITERATIONS; i++) {
                const priceParams = { ...params, volatility: sigma };
                const theoreticalPrice = blackScholesPrice(priceParams);
                const diff = theoreticalPrice - marketPrice;

                if (Math.abs(diff) < NEWTON_RAPHSON_TOLERANCE) {
                    return sigma;
                }

                const greeks = calculateGreeks(priceParams);
                const vega = greeks.vega;

                // Si vega es muy peque√±o, ajustar manualmente
                if (Math.abs(vega) < 1e-10) {
                    sigma = diff > 0 ? sigma * 0.8 : sigma * 1.2;
                } else {
                    // Newton-Raphson: œÉ_new = œÉ - f(œÉ)/f'(œÉ)
                    sigma = sigma - diff / vega;
                }

                // Mantener dentro de l√≠mites
                sigma = Math.max(IV_BOUNDS.min, Math.min(IV_BOUNDS.max, sigma));
            }

            return null; // No convergi√≥
        }

        /**
         * Calcula el punto de breakeven para un warrant.
         * 
         * @param {string} type - 'call' o 'put'
         * @param {number} strike - Precio de ejercicio
         * @param {number} premium - Prima del warrant
         * @param {number} ratio - Ratio de conversi√≥n
         * @returns {number} - Precio de breakeven del subyacente
         */
        function calculateBreakeven(type, strike, premium, ratio) {
            // Premium por unidad de subyacente
            const premiumPerUnit = premium / ratio;
            return type === 'call' 
                ? strike + premiumPerUnit 
                : strike - premiumPerUnit;
        }

        /**
         * Ajusta la volatilidad ATM seg√∫n el skew de mercado para √≠ndices de renta variable.
         * 
         * El skew captura el fen√≥meno donde opciones OTM (especialmente PUTs) cotizan
         * con volatilidades impl√≠citas superiores a las ATM.
         * 
         * @param {number} sigmaATM - Volatilidad ATM en % (ej: 28 para 28%)
         * @param {number} S - Precio spot del subyacente
         * @param {number} K - Precio de ejercicio (strike)
         * @param {number} T - Tiempo a vencimiento en a√±os
         * @param {string} type - 'call' o 'put'
         * @returns {number} - Volatilidad ajustada en %
         */
        function adjustVolatilityForSkew(sigmaATM, S, K, T, type) {
            // Par√°metros calibrados para √≠ndices de renta variable
            const putSkewIntensity = 2.2;
            const callSkewIntensity = 0.5;
            const smileCurvature = 0.5;
            const timeDecayExponent = 0.4;

            if (sigmaATM <= 0 || S <= 0 || K <= 0 || T <= 0) return sigmaATM;

            const logMoneyness = Math.log(S / K);
            const T_ref = 30 / DAYS_PER_YEAR;
            const timeFactor = Math.min(2.5, Math.pow(T_ref / Math.max(T, T_ref / 10), timeDecayExponent));

            let skewAdjustment;

            if (type === 'put') {
                if (logMoneyness > 0) {
                    skewAdjustment = putSkewIntensity * logMoneyness * timeFactor
                                   + smileCurvature * logMoneyness * logMoneyness;
                } else {
                    skewAdjustment = putSkewIntensity * logMoneyness * timeFactor * 0.25
                                   + smileCurvature * logMoneyness * logMoneyness * 0.4;
                }
            } else {
                if (logMoneyness < 0) {
                    skewAdjustment = -callSkewIntensity * logMoneyness * timeFactor
                                   + smileCurvature * logMoneyness * logMoneyness * 0.3;
                } else {
                    skewAdjustment = callSkewIntensity * logMoneyness * timeFactor * 0.15
                                   + smileCurvature * logMoneyness * logMoneyness * 0.2;
                }
            }

            const adjustedVol = sigmaATM * (1 + skewAdjustment);
            return Math.max(sigmaATM * 0.6, Math.min(sigmaATM * 2.5, adjustedVol));
        }

        /**
         * Determina el estado de moneyness de una opci√≥n.
         * 
         * @param {string} type - 'call' o 'put'
         * @param {number} spot - Precio spot
         * @param {number} strike - Precio de ejercicio
         * @returns {Object} - { status: string, color: string, ratio: number }
         */
        function getMoneyness(type, spot, strike) {
            const ratio = spot / strike;
            
            if (type === 'call') {
                if (ratio > 1.02) return { status: 'ITM', color: COLORS.success, ratio };
                if (ratio < 0.98) return { status: 'OTM', color: COLORS.danger, ratio };
                return { status: 'ATM', color: COLORS.warning, ratio };
            } else {
                if (ratio < 0.98) return { status: 'ITM', color: COLORS.success, ratio };
                if (ratio > 1.02) return { status: 'OTM', color: COLORS.danger, ratio };
                return { status: 'ATM', color: COLORS.warning, ratio };
            }
        }

        // ============================================================================
        // SECCI√ìN 3: VALIDACI√ìN DE INPUTS
        // ============================================================================

        /**
         * Configuraci√≥n de validaci√≥n para cada campo.
         */
        const VALIDATION_RULES = {
            spot: { min: 0.01, max: 1000000, message: 'Debe ser positivo' },
            strike: { min: 0.01, max: 1000000, message: 'Debe ser positivo' },
            days: { min: 1, max: 3650, message: 'Rango: 1-3650 d√≠as' },
            riskFree: { min: -5, max: 50, message: 'Rango: -5% a 50%' },
            dividend: { min: 0, max: 30, message: 'Rango: 0-30%' },
            ratio: { min: 0.0001, max: 1000, message: 'Debe ser positivo' },
            volatility: { min: 0.5, max: 300, message: 'Rango: 0.5-300%' },
            marketPrice: { min: 0.000001, max: 1000000, message: 'Debe ser positivo' }
        };

        /**
         * Valida todos los inputs del calculador.
         * 
         * @param {Object} inputs - Objeto con todos los valores de input
         * @param {string} calculationMode - 'volatility' o 'impliedVol'
         * @returns {Array} - Array de objetos { field, message }
         */
        function validateInputs(inputs, calculationMode) {
            const errors = [];
            const { spot, strike, daysToExpiration, riskFreeRate, dividendYield, conversionRatio, volatility, marketPrice } = inputs;

            const checks = [
                { value: parseFloat(spot), field: 'spot', rules: VALIDATION_RULES.spot },
                { value: parseFloat(strike), field: 'strike', rules: VALIDATION_RULES.strike },
                { value: parseInt(daysToExpiration), field: 'days', rules: VALIDATION_RULES.days },
                { value: parseFloat(riskFreeRate), field: 'riskFree', rules: VALIDATION_RULES.riskFree },
                { value: parseFloat(dividendYield), field: 'dividend', rules: VALIDATION_RULES.dividend },
                { value: parseFloat(conversionRatio), field: 'ratio', rules: VALIDATION_RULES.ratio }
            ];

            checks.forEach(({ value, field, rules }) => {
                if (isNaN(value) || value < rules.min || value > rules.max) {
                    errors.push({ field, message: rules.message });
                }
            });

            if (calculationMode === 'volatility') {
                const vol = parseFloat(volatility);
                if (isNaN(vol) || vol < VALIDATION_RULES.volatility.min || vol > VALIDATION_RULES.volatility.max) {
                    errors.push({ field: 'volatility', message: VALIDATION_RULES.volatility.message });
                }
            } else {
                const price = parseFloat(marketPrice);
                if (isNaN(price) || price <= 0) {
                    errors.push({ field: 'marketPrice', message: VALIDATION_RULES.marketPrice.message });
                }
            }

            return errors;
        }

        // ============================================================================
        // SECCI√ìN 4: COMPONENTES DE UI
        // ============================================================================

        /**
         * Componente de input num√©rico estilizado.
         */
        function NumberInput({ label, value, onChange, step, error, hint, suffix }) {
            return (
                <div className="mb-4">
                    <label className="block text-sm text-gray-400 mb-1.5">{label}</label>
                    <div className="relative">
                        <input
                            type="number"
                            value={value}
                            onChange={(e) => onChange(e.target.value)}
                            step={step || '1'}
                            className={`w-full bg-terminal-bg border rounded-lg px-3 py-2.5 text-terminal-text font-mono text-sm transition-smooth ${
                                error ? 'border-terminal-danger' : 'border-terminal-border hover:border-gray-500'
                            }`}
                        />
                        {suffix && (
                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">
                                {suffix}
                            </span>
                        )}
                    </div>
                    {error && <p className="text-terminal-danger text-xs mt-1">{error}</p>}
                    {hint && !error && <p className="text-gray-500 text-xs mt-1">{hint}</p>}
                </div>
            );
        }

        /**
         * Componente de tarjeta m√©trica.
         */
        function MetricCard({ label, value, subvalue, color, highlight }) {
            return (
                <div className={`bg-terminal-card rounded-lg border p-4 transition-smooth ${
                    highlight ? 'border-terminal-accent glow-blue' : 'border-terminal-border'
                }`}>
                    <p className="text-xs text-gray-400 mb-1 uppercase tracking-wide">{label}</p>
                    <p className={`text-xl font-bold font-mono ${color || 'text-terminal-text'}`}>
                        {value}
                    </p>
                    {subvalue && (
                        <p className="text-xs text-gray-500 mt-1 font-mono">{subvalue}</p>
                    )}
                </div>
            );
        }

        /**
         * Tooltip para gr√°fico de Payoff
         */
        function PayoffTooltip({ active, payload, label }) {
            if (!active || !payload || !payload.length) return null;
            const data = payload[0]?.payload;
            
            return (
                <div className="bg-terminal-card border border-terminal-border rounded-lg p-3 shadow-lg">
                    <p className="text-terminal-text font-mono text-sm font-bold mb-2">
                        Spot: {label}
                    </p>
                    <p className="text-gray-400 text-xs mb-2">
                        ({data?.priceChange >= 0 ? '+' : ''}{data?.priceChange}% vs actual)
                    </p>
                    <p className={`font-mono text-sm ${data?.payoff >= 0 ? 'text-terminal-success' : 'text-terminal-danger'}`}>
                        P&L: {data?.payoff >= 0 ? '+' : ''}{data?.payoff?.toFixed(2)} ‚Ç¨
                    </p>
                    <p className={`font-mono text-xs ${data?.payoffPercent >= 0 ? 'text-terminal-success' : 'text-terminal-danger'}`}>
                        ({data?.payoffPercent >= 0 ? '+' : ''}{data?.payoffPercent?.toFixed(1)}%)
                    </p>
                </div>
            );
        }

        /**
         * Tooltip para gr√°fico de evoluci√≥n de precio
         */
        function PriceEvolutionTooltip({ active, payload, label }) {
            if (!active || !payload || !payload.length) return null;
            const data = payload[0]?.payload;
            
            return (
                <div className="bg-terminal-card border border-terminal-border rounded-lg p-3 shadow-lg">
                    <p className="text-terminal-text font-mono text-sm font-bold mb-2">
                        Spot: {label}
                    </p>
                    <p className="text-gray-400 text-xs mb-2">
                        ({data?.priceChange >= 0 ? '+' : ''}{data?.priceChange}% vs actual)
                    </p>
                    {payload.map((entry, idx) => (
                        <p key={idx} style={{ color: entry.color }} className="font-mono text-sm">
                            {entry.name}: {entry.value?.toFixed(2)} cts
                        </p>
                    ))}
                </div>
            );
        }

        // ============================================================================
        // SECCI√ìN 5: COMPONENTE PRINCIPAL
        // ============================================================================

        function WarrantCalculator() {
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Estado del componente
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const [selectedAsset, setSelectedAsset] = useState('EUROSTOXX50');
            const [autoFillEnabled, setAutoFillEnabled] = useState(true);
            const [warrantType, setWarrantType] = useState('put');
            const [spot, setSpot] = useState('4950');
            const [strike, setStrike] = useState('5000');
            const [daysToExpiration, setDaysToExpiration] = useState('30');
            const [riskFreeRate, setRiskFreeRate] = useState('2.5');
            const [dividendYield, setDividendYield] = useState('2.8');
            const [conversionRatio, setConversionRatio] = useState('0.001');
            const [calculationMode, setCalculationMode] = useState('volatility');
            const [volatility, setVolatility] = useState('16');
            const [marketPrice, setMarketPrice] = useState('');
            const [enableSkewAdjustment, setEnableSkewAdjustment] = useState(true);

            const currentAsset = UNDERLYING_ASSETS[selectedAsset];

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Auto-fill cuando cambia el activo
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            useEffect(() => {
                if (autoFillEnabled && selectedAsset !== 'CUSTOM') {
                    const asset = UNDERLYING_ASSETS[selectedAsset];
                    if (asset) {
                        setSpot(String(asset.spotPrice));
                        setRiskFreeRate(String(asset.riskFreeRate));
                        setDividendYield(String(asset.dividendYield));
                        setVolatility(String(asset.volatility));
                        
                        // Strike redondeado seg√∫n magnitud del precio
                        const magnitude = Math.pow(10, Math.floor(Math.log10(asset.spotPrice)) - 1);
                        const roundedStrike = Math.round(asset.spotPrice / magnitude) * magnitude;
                        setStrike(String(roundedStrike));
                    }
                }
            }, [selectedAsset, autoFillEnabled]);

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Validaci√≥n
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const errors = useMemo(() => {
                return validateInputs({
                    spot, strike, daysToExpiration, riskFreeRate,
                    dividendYield, conversionRatio, volatility, marketPrice
                }, calculationMode);
            }, [spot, strike, daysToExpiration, riskFreeRate, dividendYield, conversionRatio, calculationMode, volatility, marketPrice]);

            const getError = useCallback((field) => {
                const err = errors.find(e => e.field === field);
                return err ? err.message : null;
            }, [errors]);

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // C√°lculos principales
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const results = useMemo(() => {
                if (errors.length > 0) return null;

                const ratio = parseFloat(conversionRatio);
                const spotNum = parseFloat(spot);
                const strikeNum = parseFloat(strike);
                const daysNum = parseInt(daysToExpiration);

                const baseParams = {
                    type: warrantType,
                    spot: spotNum,
                    strike: strikeNum,
                    daysToExpiration: daysNum,
                    riskFreeRate: parseFloat(riskFreeRate),
                    dividendYield: parseFloat(dividendYield)
                };

                let premium, impliedVol, usedVolatility, inputVolatility;

                if (calculationMode === 'volatility') {
                    inputVolatility = parseFloat(volatility);
                    
                    // Aplicar ajuste de skew si est√° habilitado
                    if (enableSkewAdjustment) {
                        const T = daysNum / DAYS_PER_YEAR;
                        usedVolatility = adjustVolatilityForSkew(
                            inputVolatility, spotNum, strikeNum, T, warrantType
                        );
                    } else {
                        usedVolatility = inputVolatility;
                    }
                    
                    const priceParams = { ...baseParams, volatility: usedVolatility };
                    premium = blackScholesPrice(priceParams) * ratio;
                    impliedVol = null;
                } else {
                    const marketPriceNum = parseFloat(marketPrice);
                    const bsEquivalentPrice = marketPriceNum / ratio;
                    
                    const ivParams = { ...baseParams, marketPrice: bsEquivalentPrice };
                    const iv = calculateImpliedVolatility(ivParams);
                    
                    if (iv === null) return null;
                    
                    impliedVol = iv;
                    usedVolatility = iv;
                    premium = marketPriceNum;
                }

                // Calcular Greeks con la volatilidad usada
                const greekParams = { ...baseParams, volatility: usedVolatility };
                const greeks = calculateGreeks(greekParams);

                // Greeks ajustadas por ratio de conversi√≥n
                const deltaWarrant = greeks.delta * ratio;
                const gammaWarrant = greeks.gamma * ratio;
                const thetaWarrant = greeks.theta * ratio;
                const vegaWarrant = greeks.vega * ratio;
                const rhoWarrant = greeks.rho * ratio;

                // Breakeven
                const breakeven = calculateBreakeven(warrantType, strikeNum, premium, ratio);

                // Moneyness
                const moneynessInfo = getMoneyness(warrantType, spotNum, strikeNum);

                // Valor intr√≠nseco y temporal
                let intrinsicValue = warrantType === 'call'
                    ? Math.max(0, spotNum - strikeNum) * ratio
                    : Math.max(0, strikeNum - spotNum) * ratio;
                
                const timeValue = Math.max(0, premium - intrinsicValue);

                // P&L al vencimiento si el spot se mantiene
                const profitLossAtExpiry = intrinsicValue - premium;

                // Apalancamiento (leverage)
                const leverage = (spotNum * Math.abs(greeks.delta)) / (premium / ratio);

                return {
                    premium,
                    greeks: {
                        delta: greeks.delta,
                        gamma: greeks.gamma,
                        theta: greeks.theta,
                        vega: greeks.vega,
                        rho: greeks.rho
                    },
                    warrantGreeks: {
                        delta: deltaWarrant,
                        gamma: gammaWarrant,
                        theta: thetaWarrant,
                        vega: vegaWarrant,
                        rho: rhoWarrant
                    },
                    breakeven,
                    moneynessInfo,
                    intrinsicValue,
                    timeValue,
                    profitLossAtExpiry,
                    impliedVol,
                    usedVolatility,
                    leverage: isFinite(leverage) ? leverage : 0
                };
            }, [errors, warrantType, spot, strike, daysToExpiration, riskFreeRate, dividendYield, conversionRatio, calculationMode, volatility, marketPrice, enableSkewAdjustment]);

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Datos para gr√°fico de payoff
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Nota: Mostramos P&L por cada 100‚Ç¨ invertidos para mejor legibilidad
            const payoffData = useMemo(() => {
                if (!results) return [];

                const strikeNum = parseFloat(strike);
                const ratio = parseFloat(conversionRatio);
                const spotNum = parseFloat(spot);
                const premium = results.premium;
                
                // Rango centrado en el spot actual (¬±20%)
                const range = spotNum * 0.20;
                const minPrice = Math.max(spotNum - range, strikeNum * 0.5);
                const maxPrice = spotNum + range;
                const step = (maxPrice - minPrice) / 60;

                // Calcular cu√°ntos warrants compramos con 100‚Ç¨
                const inversion = 100;
                const numWarrants = Math.floor(inversion / premium);

                const data = [];
                for (let price = minPrice; price <= maxPrice; price += step) {
                    const intrinsicPerWarrant = warrantType === 'call'
                        ? Math.max(0, price - strikeNum) * ratio
                        : Math.max(0, strikeNum - price) * ratio;
                    
                    // P&L total para la inversi√≥n de 100‚Ç¨
                    const plTotal = (intrinsicPerWarrant - premium) * numWarrants;
                    const plPercent = (plTotal / inversion) * 100;
                    
                    data.push({
                        price: parseFloat(price.toFixed(0)),
                        payoff: parseFloat(plTotal.toFixed(2)),
                        payoffPercent: parseFloat(plPercent.toFixed(1)),
                        priceChange: parseFloat((((price / spotNum) - 1) * 100).toFixed(1))
                    });
                }
                return { data, numWarrants, inversion };
            }, [results, spot, strike, warrantType, conversionRatio]);

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Datos para gr√°fico de evoluci√≥n del precio en el tiempo
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Muestra c√≥mo cambia el precio del warrant conforme pasa el tiempo
            const priceEvolutionData = useMemo(() => {
                if (!results || calculationMode !== 'volatility') {
                    return { data: [], timePoints: [] };
                }

                const strikeNum = parseFloat(strike);
                const spotNum = parseFloat(spot);
                const ratio = parseFloat(conversionRatio);
                const daysNum = parseInt(daysToExpiration);
                const volNum = results.usedVolatility;
                
                // Rango centrado en spot actual (¬±15%)
                const range = spotNum * 0.15;
                const minPrice = Math.max(spotNum - range, strikeNum * 0.6);
                const maxPrice = spotNum + range;
                const step = (maxPrice - minPrice) / 30;

                // Definir puntos temporales claros
                const timePoints = [
                    { days: daysNum, label: 'Hoy', color: COLORS.primary },
                    { days: Math.max(Math.round(daysNum / 2), 1), label: `${Math.max(Math.round(daysNum / 2), 1)}d`, color: COLORS.success },
                    { days: 1, label: 'Vencimiento', color: COLORS.danger }
                ];

                const data = [];
                for (let price = minPrice; price <= maxPrice; price += step) {
                    const point = { 
                        price: parseFloat(price.toFixed(0)),
                        priceChange: parseFloat((((price / spotNum) - 1) * 100).toFixed(1))
                    };
                    
                    timePoints.forEach(tp => {
                        const params = {
                            type: warrantType,
                            spot: price,
                            strike: strikeNum,
                            daysToExpiration: tp.days,
                            riskFreeRate: parseFloat(riskFreeRate),
                            dividendYield: parseFloat(dividendYield),
                            volatility: volNum
                        };
                        // Precio del warrant (en c√©ntimos para mejor lectura)
                        const warrantPrice = blackScholesPrice(params) * ratio * 100;
                        point[tp.label] = parseFloat(warrantPrice.toFixed(2));
                    });
                    
                    data.push(point);
                }

                return { data, timePoints };
            }, [results, spot, strike, daysToExpiration, riskFreeRate, dividendYield, warrantType, conversionRatio, calculationMode]);

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Render
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-terminal-panel border-b border-terminal-border px-6 py-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold text-terminal-text tracking-tight">
                                    European Warrant Calculator
                                </h1>
                                <p className="text-xs text-gray-500 mt-0.5">
                                    Black-Scholes-Merton Model ¬∑ Full Greeks Analysis
                                </p>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-xs text-gray-600">
                                    {new Date().toLocaleDateString('es-ES')}
                                </span>
                                <span className="px-2 py-1 bg-terminal-accent/20 text-terminal-accent text-xs font-mono rounded">
                                    v3.1
                                </span>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                            {/* Panel de Inputs */}
                            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                            <div className="lg:col-span-4">
                                <div className="bg-terminal-panel rounded-xl border border-terminal-border p-5 sticky top-6">
                                    
                                    {/* Selector de Activo */}
                                    <div className="mb-6 p-4 bg-terminal-bg rounded-lg border border-terminal-accent/50">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-sm font-semibold text-terminal-accent">
                                                Subyacente
                                            </span>
                                            <label className="flex items-center text-xs text-gray-500 cursor-pointer hover:text-gray-400">
                                                <input
                                                    type="checkbox"
                                                    checked={autoFillEnabled}
                                                    onChange={(e) => setAutoFillEnabled(e.target.checked)}
                                                    className="mr-2 w-3.5 h-3.5 accent-terminal-accent"
                                                />
                                                Auto-fill
                                            </label>
                                        </div>
                                        
                                        <select
                                            value={selectedAsset}
                                            onChange={(e) => setSelectedAsset(e.target.value)}
                                            className="w-full bg-terminal-card border border-terminal-border rounded-lg px-3 py-2.5 text-terminal-text text-sm focus:border-terminal-accent transition-smooth"
                                        >
                                            {ASSET_LIST.map(item => (
                                                <option key={item.key} value={item.key}>
                                                    {UNDERLYING_ASSETS[item.key].name} ({UNDERLYING_ASSETS[item.key].ticker})
                                                </option>
                                            ))}
                                        </select>

                                        {currentAsset && !currentAsset.isCustom && (
                                            <div className="mt-3 flex flex-wrap gap-1.5">
                                                <span className="px-2 py-0.5 bg-terminal-card text-gray-400 text-xs rounded">
                                                    {currentAsset.currency}
                                                </span>
                                                <span className="px-2 py-0.5 bg-terminal-card text-gray-400 text-xs rounded">
                                                    {currentAsset.exchange}
                                                </span>
                                                {currentAsset.volIndex && (
                                                    <span className="px-2 py-0.5 bg-terminal-accent/20 text-terminal-accent text-xs rounded">
                                                        {currentAsset.volIndex}
                                                    </span>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Tipo Call/Put */}
                                    <div className="mb-6">
                                        <label className="block text-sm text-gray-400 mb-2">Tipo</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button
                                                onClick={() => setWarrantType('call')}
                                                className={`py-2.5 rounded-lg font-semibold text-sm transition-smooth ${
                                                    warrantType === 'call'
                                                        ? 'bg-terminal-success text-white glow-green'
                                                        : 'bg-terminal-card text-gray-400 hover:bg-gray-700'
                                                }`}
                                            >
                                                CALL ‚ñ≤
                                            </button>
                                            <button
                                                onClick={() => setWarrantType('put')}
                                                className={`py-2.5 rounded-lg font-semibold text-sm transition-smooth ${
                                                    warrantType === 'put'
                                                        ? 'bg-terminal-danger text-white glow-red'
                                                        : 'bg-terminal-card text-gray-400 hover:bg-gray-700'
                                                }`}
                                            >
                                                PUT ‚ñº
                                            </button>
                                        </div>
                                    </div>

                                    {/* Inputs principales */}
                                    <div className="space-y-1">
                                        <NumberInput
                                            label="Spot Price (S)"
                                            value={spot}
                                            onChange={setSpot}
                                            step="0.01"
                                            error={getError('spot')}
                                        />

                                        <NumberInput
                                            label="Strike Price (K)"
                                            value={strike}
                                            onChange={setStrike}
                                            step="0.01"
                                            error={getError('strike')}
                                        />

                                        <NumberInput
                                            label="Days to Expiration"
                                            value={daysToExpiration}
                                            onChange={setDaysToExpiration}
                                            step="1"
                                            error={getError('days')}
                                        />

                                        <div className="grid grid-cols-2 gap-3">
                                            <NumberInput
                                                label="Risk-Free Rate"
                                                value={riskFreeRate}
                                                onChange={setRiskFreeRate}
                                                step="0.1"
                                                suffix="%"
                                                error={getError('riskFree')}
                                            />
                                            <NumberInput
                                                label="Dividend Yield"
                                                value={dividendYield}
                                                onChange={setDividendYield}
                                                step="0.1"
                                                suffix="%"
                                                error={getError('dividend')}
                                            />
                                        </div>

                                        <NumberInput
                                            label="Conversion Ratio"
                                            value={conversionRatio}
                                            onChange={setConversionRatio}
                                            step="0.001"
                                            hint="BNP t√≠pico: 0.001 o 0.01"
                                            error={getError('ratio')}
                                        />
                                    </div>

                                    {/* Modo de c√°lculo */}
                                    <div className="mt-6 pt-5 border-t border-terminal-border">
                                        <label className="block text-sm text-gray-400 mb-2">Modo de C√°lculo</label>
                                        <select
                                            value={calculationMode}
                                            onChange={(e) => setCalculationMode(e.target.value)}
                                            className="w-full bg-terminal-bg border border-terminal-border rounded-lg px-3 py-2.5 text-terminal-text text-sm mb-4"
                                        >
                                            <option value="volatility">œÉ ‚Üí Precio te√≥rico</option>
                                            <option value="impliedVol">Precio ‚Üí IV</option>
                                        </select>

                                        {calculationMode === 'volatility' ? (
                                            <>
                                                <NumberInput
                                                    label="Volatilidad (œÉ)"
                                                    value={volatility}
                                                    onChange={setVolatility}
                                                    step="0.5"
                                                    suffix="%"
                                                    error={getError('volatility')}
                                                />
                                                
                                                {/* Control de Volatility Skew */}
                                                <div className="mt-3 p-3 bg-terminal-bg rounded-lg border border-terminal-border">
                                                    <div className="flex items-center justify-between">
                                                        <label className="flex items-center cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={enableSkewAdjustment}
                                                                onChange={(e) => setEnableSkewAdjustment(e.target.checked)}
                                                                className="mr-2 w-4 h-4 accent-terminal-warning"
                                                            />
                                                            <span className="text-sm text-terminal-text">
                                                                Volatility Skew
                                                            </span>
                                                        </label>
                                                        {enableSkewAdjustment && results && (
                                                            <span className="text-sm text-terminal-warning font-mono">
                                                                œÉ: {results.usedVolatility.toFixed(1)}%
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        Ajusta œÉ seg√∫n moneyness (OTM ‚Üí mayor IV)
                                                    </p>
                                                </div>
                                            </>
                                        ) : (
                                            <NumberInput
                                                label="Precio de Mercado"
                                                value={marketPrice}
                                                onChange={setMarketPrice}
                                                step="0.0001"
                                                suffix="EUR"
                                                error={getError('marketPrice')}
                                            />
                                        )}
                                    </div>

                                    <p className="text-xs text-gray-600 mt-4 p-3 bg-terminal-bg rounded-lg">
                                        ‚ö†Ô∏è Datos orientativos. Verificar antes de operar.
                                    </p>
                                </div>
                            </div>

                            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                            {/* Panel de Resultados */}
                            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                            <div className="lg:col-span-8 space-y-6">
                                {results ? (
                                    <>
                                        {/* M√©tricas principales */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <MetricCard
                                                label="Premium"
                                                value={`${results.premium.toFixed(4)} ‚Ç¨`}
                                                subvalue={`TV: ${results.timeValue.toFixed(4)}`}
                                                color="text-terminal-accent"
                                                highlight={true}
                                            />
                                            <MetricCard
                                                label="Delta (Œî)"
                                                value={results.greeks.delta.toFixed(4)}
                                                subvalue={`Warrant: ${results.warrantGreeks.delta.toFixed(6)}`}
                                                color={results.greeks.delta >= 0 ? 'text-terminal-success' : 'text-terminal-danger'}
                                            />
                                            <MetricCard
                                                label="Breakeven"
                                                value={results.breakeven.toFixed(2)}
                                                subvalue={`S/K: ${results.moneynessInfo.ratio.toFixed(4)}`}
                                            />
                                            <MetricCard
                                                label="P&L @ Expiry"
                                                value={`${results.profitLossAtExpiry >= 0 ? '+' : ''}${results.profitLossAtExpiry.toFixed(4)} ‚Ç¨`}
                                                subvalue={`si Spot = ${spot}`}
                                                color={results.profitLossAtExpiry >= 0 ? 'text-terminal-success' : 'text-terminal-danger'}
                                            />
                                        </div>

                                        {/* Greeks completas */}
                                        <div className="bg-terminal-panel rounded-xl border border-terminal-border p-5">
                                            <h3 className="text-sm font-semibold text-terminal-text mb-4 flex items-center gap-2">
                                                <span className="w-2 h-2 bg-terminal-accent rounded-full"></span>
                                                Greeks Analysis
                                            </h3>
                                            <div className="grid grid-cols-5 gap-3">
                                                <div className="text-center p-3 bg-terminal-bg rounded-lg">
                                                    <p className="text-xs text-gray-500 mb-1">Delta (Œî)</p>
                                                    <p className="text-lg font-mono font-bold text-terminal-text">
                                                        {results.greeks.delta.toFixed(4)}
                                                    </p>
                                                    <p className="text-xs text-gray-600 mt-1">‚àÇV/‚àÇS</p>
                                                </div>
                                                <div className="text-center p-3 bg-terminal-bg rounded-lg">
                                                    <p className="text-xs text-gray-500 mb-1">Gamma (Œì)</p>
                                                    <p className="text-lg font-mono font-bold text-terminal-text">
                                                        {results.greeks.gamma.toFixed(6)}
                                                    </p>
                                                    <p className="text-xs text-gray-600 mt-1">‚àÇ¬≤V/‚àÇS¬≤</p>
                                                </div>
                                                <div className="text-center p-3 bg-terminal-bg rounded-lg">
                                                    <p className="text-xs text-gray-500 mb-1">Theta (Œò)</p>
                                                    <p className="text-lg font-mono font-bold text-terminal-danger">
                                                        {results.greeks.theta.toFixed(4)}
                                                    </p>
                                                    <p className="text-xs text-gray-600 mt-1">‚Ç¨/d√≠a</p>
                                                </div>
                                                <div className="text-center p-3 bg-terminal-bg rounded-lg">
                                                    <p className="text-xs text-gray-500 mb-1">Vega (ŒΩ)</p>
                                                    <p className="text-lg font-mono font-bold text-terminal-text">
                                                        {results.greeks.vega.toFixed(4)}
                                                    </p>
                                                    <p className="text-xs text-gray-600 mt-1">‚Ç¨/1% œÉ</p>
                                                </div>
                                                <div className="text-center p-3 bg-terminal-bg rounded-lg">
                                                    <p className="text-xs text-gray-500 mb-1">Rho (œÅ)</p>
                                                    <p className="text-lg font-mono font-bold text-terminal-text">
                                                        {results.greeks.rho.toFixed(4)}
                                                    </p>
                                                    <p className="text-xs text-gray-600 mt-1">‚Ç¨/1% r</p>
                                                </div>
                                            </div>

                                            {/* Info adicional */}
                                            <div className="mt-4 pt-4 border-t border-terminal-border grid grid-cols-3 gap-4 text-center">
                                                <div>
                                                    <p className="text-xs text-gray-500">Moneyness</p>
                                                    <p className="font-bold" style={{ color: results.moneynessInfo.color }}>
                                                        {results.moneynessInfo.status}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-gray-500">Apalancamiento</p>
                                                    <p className="font-bold text-terminal-text">
                                                        {results.leverage.toFixed(1)}x
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-gray-500">
                                                        {results.impliedVol !== null ? 'Implied Vol' : 'Volatilidad'}
                                                    </p>
                                                    <p className="font-bold text-terminal-accent">
                                                        {results.usedVolatility.toFixed(2)}%
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Gr√°fico de Payoff */}
                                        <div className="bg-terminal-panel rounded-xl border border-terminal-border p-5">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="text-sm font-semibold text-terminal-text flex items-center gap-2">
                                                        <span className="w-2 h-2 bg-terminal-success rounded-full"></span>
                                                        P&L al Vencimiento
                                                    </h3>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        Simulaci√≥n con {payoffData.numWarrants} warrants ({payoffData.inversion}‚Ç¨ invertidos)
                                                    </p>
                                                </div>
                                                <div className="text-right text-xs text-gray-500">
                                                    <p>Eje X: Precio spot</p>
                                                    <p>Eje Y: Ganancia/P√©rdida (‚Ç¨)</p>
                                                </div>
                                            </div>
                                            <ResponsiveContainer width="100%" height={280}>
                                                <AreaChart data={payoffData.data}>
                                                    <defs>
                                                        <linearGradient id="payoffGradient" x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="5%" stopColor={warrantType === 'call' ? COLORS.success : COLORS.danger} stopOpacity={0.3}/>
                                                            <stop offset="95%" stopColor={warrantType === 'call' ? COLORS.success : COLORS.danger} stopOpacity={0}/>
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" stroke={COLORS.border} />
                                                    <XAxis 
                                                        dataKey="price" 
                                                        stroke={COLORS.muted} 
                                                        tick={{ fill: COLORS.muted, fontSize: 11 }}
                                                        tickFormatter={(v) => v.toLocaleString()}
                                                    />
                                                    <YAxis 
                                                        stroke={COLORS.muted} 
                                                        tick={{ fill: COLORS.muted, fontSize: 11 }}
                                                        tickFormatter={(v) => `${v >= 0 ? '+' : ''}${v.toFixed(0)}‚Ç¨`}
                                                    />
                                                    <Tooltip content={<PayoffTooltip />} />
                                                    <ReferenceLine y={0} stroke={COLORS.text} strokeWidth={1} />
                                                    <ReferenceLine 
                                                        x={parseFloat(strike)} 
                                                        stroke={COLORS.muted} 
                                                        strokeDasharray="5 5" 
                                                        label={{ value: `K=${strike}`, fill: COLORS.muted, fontSize: 9, position: 'top' }} 
                                                    />
                                                    <ReferenceLine 
                                                        x={results.breakeven} 
                                                        stroke={COLORS.warning} 
                                                        strokeDasharray="5 5" 
                                                        label={{ value: `BE=${results.breakeven.toFixed(0)}`, fill: COLORS.warning, fontSize: 9, position: 'top' }} 
                                                    />
                                                    <Area 
                                                        type="monotone" 
                                                        dataKey="payoff" 
                                                        name="P&L"
                                                        stroke={warrantType === 'call' ? COLORS.success : COLORS.danger} 
                                                        strokeWidth={2}
                                                        fill="url(#payoffGradient)"
                                                    />
                                                </AreaChart>
                                            </ResponsiveContainer>
                                            <p className="text-xs text-gray-600 mt-3 text-center">
                                                üìç Strike (K) = {strike} | üéØ Breakeven = {results.breakeven.toFixed(0)} | 
                                                {warrantType === 'put' ? ' Ganas si el √≠ndice BAJA' : ' Ganas si el √≠ndice SUBE'}
                                            </p>
                                        </div>

                                        {/* Gr√°fico de evoluci√≥n del precio en el tiempo */}
                                        {calculationMode === 'volatility' && priceEvolutionData.data.length > 0 && (
                                            <div className="bg-terminal-panel rounded-xl border border-terminal-border p-5">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h3 className="text-sm font-semibold text-terminal-text flex items-center gap-2">
                                                            <span className="w-2 h-2 bg-terminal-warning rounded-full"></span>
                                                            Evoluci√≥n del Precio del Warrant
                                                        </h3>
                                                        <p className="text-xs text-gray-500 mt-1">
                                                            C√≥mo cambia el precio conforme pasa el tiempo (efecto Theta)
                                                        </p>
                                                    </div>
                                                    <div className="text-right text-xs text-gray-500">
                                                        <p>Eje X: Precio spot</p>
                                                        <p>Eje Y: Precio warrant (cts)</p>
                                                    </div>
                                                </div>
                                                <ResponsiveContainer width="100%" height={280}>
                                                    <LineChart data={priceEvolutionData.data}>
                                                        <CartesianGrid strokeDasharray="3 3" stroke={COLORS.border} />
                                                        <XAxis 
                                                            dataKey="price" 
                                                            stroke={COLORS.muted} 
                                                            tick={{ fill: COLORS.muted, fontSize: 11 }}
                                                            tickFormatter={(v) => v.toLocaleString()}
                                                        />
                                                        <YAxis 
                                                            stroke={COLORS.muted} 
                                                            tick={{ fill: COLORS.muted, fontSize: 11 }}
                                                            tickFormatter={(v) => `${v.toFixed(1)}`}
                                                            label={{ value: 'cts', angle: -90, position: 'insideLeft', fill: COLORS.muted, fontSize: 10 }}
                                                        />
                                                        <Tooltip content={<PriceEvolutionTooltip />} />
                                                        <Legend />
                                                        <ReferenceLine 
                                                            x={parseFloat(spot)} 
                                                            stroke={COLORS.text} 
                                                            strokeDasharray="5 5"
                                                            label={{ value: 'Spot actual', fill: COLORS.text, fontSize: 9, position: 'top' }}
                                                        />
                                                        {priceEvolutionData.timePoints.map((tp, idx) => {
                                                            const colors = [COLORS.primary, COLORS.success, COLORS.danger];
                                                            return (
                                                                <Line 
                                                                    key={tp.label} 
                                                                    type="monotone" 
                                                                    dataKey={tp.label} 
                                                                    name={tp.label}
                                                                    stroke={colors[idx % 3]} 
                                                                    strokeWidth={2} 
                                                                    dot={false}
                                                                />
                                                            );
                                                        })}
                                                    </LineChart>
                                                </ResponsiveContainer>
                                                <p className="text-xs text-gray-600 mt-3 text-center">
                                                    ‚è≥ A medida que pasa el tiempo, el valor temporal del warrant decrece (Theta negativo)
                                                </p>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div className="bg-terminal-panel rounded-xl border border-terminal-danger/50 p-8 text-center">
                                        <div className="text-terminal-danger text-4xl mb-3">‚ö†</div>
                                        <p className="text-terminal-danger font-semibold">
                                            {errors.length > 0 ? 'Corrige los errores de validaci√≥n' : 'No se pudo calcular la IV'}
                                        </p>
                                        {errors.length > 0 && (
                                            <ul className="mt-3 text-sm text-gray-400">
                                                {errors.map((e, i) => (
                                                    <li key={i}>{e.field}: {e.message}</li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="bg-terminal-panel border-t border-terminal-border px-6 py-4 mt-12">
                        <div className="max-w-7xl mx-auto flex justify-between items-center text-xs text-gray-600">
                            <p>European Warrant Calculator v3.1 ¬∑ Black-Scholes-Merton + Volatility Skew</p>
                            <p>Solo para fines educativos ¬∑ No es asesoramiento financiero</p>
                        </div>
                    </footer>
                </div>
            );
        }

        // ============================================================================
        // PUNTO DE ENTRADA
        // ============================================================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(WarrantCalculator));
    </script>
</body>
</html>
